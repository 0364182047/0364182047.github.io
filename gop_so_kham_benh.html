<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Gộp File Sổ Khám Bệnh v1.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .file-item {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .btn-primary {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary:disabled {
            transform: none;
            box-shadow: none;
        }

        #drop-zone {
            border-style: dashed;
            transition: all 0.3s ease-in-out;
        }

        #drop-zone.dragover {
            background-color: #e0f2fe;
            border-color: #0284c7;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">
    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="relative w-full max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8">
            <!-- Top Signature -->
            <div id="top-signature" class="absolute top-4 left-6 text-3xl text-slate-700" style="font-family: 'Dancing Script', cursive;">Dr.Liph</div>
            
            <header class="text-center mb-6 md:mb-8">
                <div class="flex justify-center items-center gap-4 mb-3">
                     <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0D 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    <h1 class="text-3xl md:text-4xl font-bold text-slate-800">Gộp Sổ Khám Bệnh v1.4</h1>
                </div>
                <p class="text-slate-500 max-w-2xl mx-auto">Tải lên nhiều file Excel để gộp thành một file duy nhất với định dạng cột chuẩn và dữ liệu được tự động tính toán, sắp xếp.</p>
            </header>

            <main>
                <!-- File Upload Section -->
                <div id="upload-section">
                    <label for="file-upload" id="drop-zone" class="flex flex-col items-center justify-center w-full h-48 md:h-64 p-6 border-2 border-slate-300 rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-10 h-10 mb-4 text-sky-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2" />
                            </svg>
                            <p class="mb-2 text-lg font-semibold text-slate-600"><span class="font-bold text-sky-600">Nhấn để chọn file</span> hoặc kéo thả vào đây</p>
                            <p class="text-sm text-slate-500">Hỗ trợ định dạng .XLSX, .XLS, .CSV</p>
                        </div>
                        <input id="file-upload" type="file" class="hidden" multiple accept=".xlsx, .xls, .csv" />
                    </label>

                    <div id="file-list-container" class="mt-6 hidden">
                        <h3 class="font-semibold text-slate-700 mb-2">Các file đã chọn:</h3>
                        <ul id="file-list" class="space-y-2"></ul>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div id="action-buttons" class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                    <button id="merge-btn" disabled class="btn-primary w-full sm:w-auto text-white bg-sky-600 hover:bg-sky-700 disabled:bg-slate-300 disabled:cursor-not-allowed font-semibold rounded-lg text-base px-8 py-3 text-center">
                        <span class="flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M12 11v6"></path><path d="M9 14h6"></path></svg>
                            Bắt đầu Gộp
                        </span>
                    </button>
                    <button id="clear-btn" class="w-full sm:w-auto text-slate-600 bg-slate-200 hover:bg-slate-300 font-semibold rounded-lg text-base px-8 py-3 text-center hidden">
                        Làm lại
                    </button>
                </div>

                <!-- Status and Result Section -->
                <div id="status-section" class="mt-8 text-center hidden">
                    <div id="loading" class="flex items-center justify-center gap-3 text-sky-600 hidden">
                        <svg class="animate-spin h-6 w-6 text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="font-semibold text-lg">Đang xử lý, vui lòng chờ...</p>
                    </div>
                    <div id="result" class="hidden p-6 bg-emerald-50 text-emerald-800 border border-emerald-200 rounded-lg">
                        <h3 class="text-xl font-bold mb-2">Hoàn tất!</h3>
                        <p id="result-message" class="mb-4"></p>
                        <button id="download-btn" class="btn-primary text-white bg-emerald-600 hover:bg-emerald-700 font-semibold rounded-lg text-base px-8 py-3 text-center">
                             <span class="flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                Tải File Tổng Hợp
                            </span>
                        </button>
                    </div>
                     <div id="error" class="hidden p-6 bg-red-50 text-red-800 border border-red-200 rounded-lg">
                        <h3 class="text-xl font-bold mb-2">Đã xảy ra lỗi</h3>
                        <p id="error-message"></p>
                    </div>
                </div>
                 <!-- Preview Section -->
                <div id="preview-section" class="mt-8 hidden">
                    <h3 class="text-xl font-semibold text-slate-700 mb-4">Xem trước dữ liệu đã gộp (15 dòng đầu)</h3>
                    <div class="overflow-x-auto border border-slate-200 rounded-lg">
                        <table class="min-w-full text-sm text-left text-slate-600">
                            <thead id="preview-head" class="text-xs text-slate-700 uppercase bg-slate-100">
                            </thead>
                            <tbody id="preview-body" class="bg-white divide-y divide-slate-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>

            <!-- Bottom Signature -->
            <div id="bottom-signature" class="text-center mt-8 text-slate-700">
                <p>BS.Phạm Hải Linh - TYT xã Xuân Bắc</p>
            </div>
        </div>
        <footer class="text-center mt-6 text-slate-500 text-sm">
            <p>Công cụ hỗ trợ Trạm Y tế xã Xuân Bắc. Phiên bản 1.4.</p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const dropZone = document.getElementById('drop-zone');
        const fileUpload = document.getElementById('file-upload');
        const fileListContainer = document.getElementById('file-list-container');
        const fileList = document.getElementById('file-list');
        const mergeBtn = document.getElementById('merge-btn');
        const clearBtn = document.getElementById('clear-btn');
        const statusSection = document.getElementById('status-section');
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');
        const resultMessage = document.getElementById('result-message');
        const downloadBtn = document.getElementById('download-btn');
        const error = document.getElementById('error');
        const errorMessage = document.getElementById('error-message');
        const previewSection = document.getElementById('preview-section');
        const previewHead = document.getElementById('preview-head');
        const previewBody = document.getElementById('preview-body');

        let selectedFiles = [];
        let mergedData = [];
        let finalHeaders = [];

        // Drag and Drop functionality
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFiles(files);
        });
        fileUpload.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Handle selected files
        function handleFiles(files) {
            selectedFiles = [...files];
            fileList.innerHTML = '';
            if (selectedFiles.length > 0) {
                selectedFiles.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'file-item flex items-center bg-slate-100 p-2 rounded-md text-sm';
                    li.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500 mr-2 flex-shrink-0"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                        <span class="font-medium truncate">${file.name}</span>
                        <span class="ml-auto text-slate-500">${(file.size / 1024).toFixed(2)} KB</span>`;
                    fileList.appendChild(li);
                });
                fileListContainer.classList.remove('hidden');
                mergeBtn.disabled = false;
                clearBtn.classList.remove('hidden');
            } else {
                resetUI();
            }
        }

        // Helper function to process date of birth string
        function processDateOfBirth(dobString) {
            if (!dobString) return { ngaySinh: '', namSinh: '' };
            
            dobString = String(dobString).trim();

            if (/^\d{4}$/.test(dobString)) { // Case: '1999'
                return { ngaySinh: dobString, namSinh: dobString };
            }

            const match = dobString.match(/(\d{1,2})[./-](\d{1,2})[./-](\d{4})/);
            if (match) { // Case: 'dd/mm/yyyy'
                const day = match[1].padStart(2, '0');
                const month = match[2].padStart(2, '0');
                const year = match[3];
                return { ngaySinh: `${day}/${month}/${year}`, namSinh: year };
            }
            
            const yearMatch = dobString.match(/\d{4}/); // Fallback to find any 4-digit year
            const namSinh = yearMatch ? yearMatch[0] : '';
            return { ngaySinh: dobString, namSinh: namSinh };
        }

        // Merge button click handler
        mergeBtn.addEventListener('click', async () => {
            resetStatus();
            statusSection.classList.remove('hidden');
            loading.classList.remove('hidden');
            mergeBtn.disabled = true;
            clearBtn.disabled = true;

            let allPatientData = [];
            
            try {
                for (const file of selectedFiles) {
                    const data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (err) => reject(err);
                        reader.readAsArrayBuffer(file);
                    });

                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('sổ khám bệnh'));
                    if (!sheetName) {
                        console.warn(`Không tìm thấy sheet "Sổ khám bệnh" trong file: ${file.name}. Bỏ qua.`);
                        continue;
                    }

                    const worksheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                    let currentDate = null;
                    for (const row of rows) {
                        if (typeof row[0] === 'string' && row[0].trim().toLowerCase().startsWith('ngày')) {
                            const dateString = row[0].replace(/ngày/i, '').trim();
                            const parts = dateString.match(/(\d{1,2})[/-](\d{1,2})[/-](\d{4})/);
                            if (parts) {
                                currentDate = new Date(parts[3], parts[2] - 1, parts[1]);
                            }
                        } 
                        else if (!isNaN(parseInt(row[0])) && row[1] && row[0] > 0) {
                            if (currentDate) {
                                allPatientData.push({ ngayKham: currentDate, dataRow: row });
                            }
                        }
                    }
                }

                if (allPatientData.length === 0) {
                    throw new Error("Không tìm thấy dữ liệu bệnh nhân hợp lệ trong các file đã chọn.");
                }

                allPatientData.sort((a, b) => a.ngayKham - b.ngayKham);

                finalHeaders = [
                    'STT', 'ngay kham', 'thang kham', 'HỌ VÀ TÊN', 'Tên', 'Ngày sinh', 'Năm sinh',
                    'giới', 'CCCD', 'SỐ THẺ BHYT', 'ĐỊA CHỈ', 'NGHỀ NGHIỆP', 'DÂN TỘC',
                    'TRIỆU CHỨNG', 'CHẨN ĐOÁN', 'PHƯƠNG PHÁP ĐIỀU TRỊ', 'Y, BÁC SĨ KHÁM BỆNH',
                    'GHI CHÚ', 'BỆNH ÁN'
                ];
                
                mergedData = [finalHeaders];
                let stt = 1;

                allPatientData.forEach(patient => {
                    const data = patient.dataRow;
                    const examDate = patient.ngayKham;

                    const ngayKhamText = examDate.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const thangKhamText = examDate.getFullYear() + '.' + String(examDate.getMonth() + 1).padStart(2, '0');
                    const hoVaTen = data[1] || '';
                    const ten = hoVaTen.split(' ').pop() || '';
                    const { ngaySinh, namSinh } = processDateOfBirth(data[3]);
                    let gioi = data[2] || '';
                    if (gioi) {
                       gioi = gioi.trim().toLowerCase().startsWith('na') ? 'Nam' : (gioi.trim().toLowerCase().startsWith('n') ? 'Nữ' : gioi);
                    }

                    const newRow = [
                        stt++,
                        ngayKhamText,
                        thangKhamText,
                        hoVaTen,
                        ten,
                        ngaySinh,
                        namSinh,
                        gioi,
                        data[4] || '',  // CCCD
                        data[5] || '',  // SỐ THẺ BHYT
                        data[6] || '',  // ĐỊA CHỈ
                        data[7] || '',  // NGHỀ NGHIỆP
                        data[8] || '',  // DÂN TỘC
                        data[9] || '',  // TRIỆU CHỨNG
                        data[10] || '', // CHẨN ĐOÁN
                        data[11] || '', // PHƯƠNG PHÁP ĐIỀU TRỊ
                        data[12] || '', // Y, BÁC SĨ KHÁM BỆNH
                        data[13] || '', // GHI CHÚ
                        ''              // BỆNH ÁN (empty)
                    ];
                    mergedData.push(newRow);
                });
                
                loading.classList.add('hidden');
                result.classList.remove('hidden');
                resultMessage.textContent = `Đã gộp thành công ${allPatientData.length} lượt khám từ ${selectedFiles.length} file.`;
                
                renderPreview();
                previewSection.classList.remove('hidden');

            } catch (err) {
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                errorMessage.textContent = err.message || "Có lỗi xảy ra trong quá trình xử lý file.";
                console.error(err);
            } finally {
                mergeBtn.disabled = false;
                clearBtn.disabled = false;
            }
        });

        function renderPreview() {
            previewHead.innerHTML = '';
            previewBody.innerHTML = '';

            const headerRow = document.createElement('tr');
            finalHeaders.forEach(headerText => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.className = 'px-6 py-3';
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            previewHead.appendChild(headerRow);

            const dataToPreview = mergedData.slice(1, 16);
            dataToPreview.forEach(rowData => {
                const row = document.createElement('tr');
                rowData.forEach(cellData => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap';
                    td.textContent = cellData;
                    row.appendChild(td);
                });
                previewBody.appendChild(row);
            });
        }
        
        // Download button click handler
        downloadBtn.addEventListener('click', () => {
            if (mergedData.length > 1) {
                const ws = XLSX.utils.aoa_to_sheet(mergedData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'SoKhamBenh_TongHop');
                XLSX.writeFile(wb, 'SoKhamBenh_TongHop_v1.4.xlsx');
            }
        });

        // Clear button click handler
        clearBtn.addEventListener('click', resetUI);
        
        // UI Reset functions
        function resetUI() {
            selectedFiles = [];
            mergedData = [];
            finalHeaders = [];
            fileUpload.value = '';
            fileList.innerHTML = '';
            fileListContainer.classList.add('hidden');
            mergeBtn.disabled = true;
            clearBtn.classList.add('hidden');
            resetStatus();
            previewSection.classList.add('hidden');
        }

        function resetStatus(){
            statusSection.classList.add('hidden');
            loading.classList.add('hidden');
            result.classList.add('hidden');
            error.classList.add('hidden');
        }

    </script>

</body>

</html>

